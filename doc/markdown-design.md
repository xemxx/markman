# Markman 编辑器架构说明

## 1. 架构概述

Markman 的编辑器部分采用解耦的事件驱动架构，主要由以下几部分组成：

1. **编辑器组件**（CrepeEditor.vue）：封装 Milkdown/Crepe 编辑器，管理编辑器实例
2. **编辑器状态**（editor.ts）：管理笔记状态，提供保存和同步功能
3. **事件总线**（emitter.ts）：组件之间的通信机制
4. **事件监听器**（listen.ts）：处理系统事件，如键盘快捷键

## 2. 核心设计原则

1. **内容访问分离**：编辑器内容由组件独立管理
2. **事件驱动通信**：使用事件总线实现组件间松耦合通信
3. **错误处理优先**：所有核心操作都包含错误处理逻辑，保证系统稳定性
4. **状态同步机制**：提供备选方案确保内容不会丢失

## 3. 数据流

### 保存笔记流程

1. 用户触发保存操作（Ctrl+S 或菜单项）
2. 事件通过 IPC 发送到渲染进程
3. `listen.ts` 捕获事件并触发 `editor:save-content` 事件
4. 编辑器组件（CrepeEditor.vue）接收事件，获取最新内容
5. 内容传递给编辑器存储
6. 编辑器存储（editor.ts）执行数据库保存操作

```
User Action → IPC → listen.ts → Event Bus → CrepeEditor → editor.ts → Database
```

### 加载笔记流程

1. 用户从侧边栏选择笔记
2. 编辑器存储加载笔记数据
3. 编辑器存储更新 `currentNote` 状态
4. 编辑器组件监听状态变化并更新编辑器内容

```
User Selection → editor.ts → State Change → CrepeEditor → UI Update
```

## 4. 错误处理策略

1. **内容获取保障**：

   - 主要通过实时跟踪编辑器内容变化
   - 编辑器实例发生异常时，使用最后记录的内容作为备选方案

2. **编辑器实例管理**：

   - 组件挂载时初始化编辑器
   - 组件卸载时清理编辑器引用
   - 预防多个编辑器实例冲突

3. **保存操作安全性**：
   - 使用锁（isSaving）防止并发保存操作
   - 保存前验证笔记 ID 等必要信息
   - 检测内容是否实际变更，避免不必要的数据库操作

## 5. 后续优化方向

1. **响应式改进**：对大型文档编辑进行性能优化
2. **冲突解决**：改进多端同步时的冲突处理机制
3. **离线编辑**：增强断网状态下的编辑和保存能力
4. **事件防抖**：对高频操作（如自动保存）增加防抖处理
